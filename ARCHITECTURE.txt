════════════════════════════════════════════════════════════════
    АРХИТЕКТУРА GPU-УСКОРЕННОГО БОТА ДЛЯ ЗМЕЙКИ
    Визуальное представление системы
════════════════════════════════════════════════════════════════


╔═══════════════════════════════════════════════════════════════╗
║                      CPU (HOST) LAYER                         ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  ┌─────────────────────────────────────────────────────────┐ ║
║  │            GAME (Snake - Source.c)                      │ ║
║  │  • Рендеринг (OpenGL)                                   │ ║
║  │  • Игровой цикл                                         │ ║
║  │  • Обработка ввода                                      │ ║
║  │  • Логика игры                                          │ ║
║  └──────────────────┬──────────────────────────────────────┘ ║
║                     │                                         ║
║                     ▼                                         ║
║  ┌─────────────────────────────────────────────────────────┐ ║
║  │            BOT CONTROLLER                               │ ║
║  │  • botControl()                                         │ ║
║  │  • Переключатель CPU/GPU                                │ ║
║  └──────────┬───────────────────────┬──────────────────────┘ ║
║             │                       │                         ║
║   ┌─────────▼────────┐    ┌────────▼─────────┐             ║
║   │   CPU BOT        │    │   GPU BOT        │             ║
║   │ (оригинал)       │    │ (новый)          │             ║
║   │                  │    │                  │             ║
║   │ • Симуляция      │    │ • hip_bot API    │             ║
║   │ • A*             │    │ • Конвертация    │             ║
║   │ • BFS            │    │   данных         │             ║
║   │ • Оценка         │    │                  │             ║
║   └──────────────────┘    └────────┬─────────┘             ║
║                                    │                         ║
╚════════════════════════════════════╪═════════════════════════╝
                                     │
              CPU-GPU Barrier        │ 
                                     │ hipMemcpy
                                     ▼
╔═══════════════════════════════════════════════════════════════╗
║                      GPU (DEVICE) LAYER                       ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  ┌─────────────────────────────────────────────────────────┐ ║
║  │            HIP BOT API (hip_bot.cpp)                    │ ║
║  │  • Управление памятью GPU                               │ ║
║  │  • Запуск kernels                                       │ ║
║  │  • Анализ результатов                                   │ ║
║  └──────────────────┬──────────────────────────────────────┘ ║
║                     │                                         ║
║                     ▼                                         ║
║  ┌─────────────────────────────────────────────────────────┐ ║
║  │            GPU KERNELS (hip_kernels.hip)                │ ║
║  └─────────────────────────────────────────────────────────┘ ║
║                     │                                         ║
║         ┌───────────┼───────────┬───────────┐                ║
║         ▼           ▼           ▼           ▼                ║
║  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐         ║
║  │Massive  │ │Parallel  │ │Parallel │ │Evaluate  │         ║
║  │Simula-  │ │  A*      │ │  BFS    │ │States    │         ║
║  │tion     │ │          │ │         │ │          │         ║
║  │         │ │          │ │         │ │          │         ║
║  │4096     │ │Тысячи    │ │Свободное│ │Много-    │         ║
║  │парал-   │ │путей     │ │простран-│ │критери-  │         ║
║  │лельных  │ │одновре-  │ │ство     │ │альная    │         ║
║  │симуля-  │ │менно     │ │         │ │оценка    │         ║
║  │ций      │ │          │ │         │ │          │         ║
║  └─────────┘ └──────────┘ └─────────┘ └──────────┘         ║
║                                                               ║
║  ┌─────────────────────────────────────────────────────────┐ ║
║  │         ADVANCED KERNELS (hip_mcts.hip)                 │ ║
║  └─────────────────────────────────────────────────────────┘ ║
║                     │                                         ║
║         ┌───────────┴───────────┐                            ║
║         ▼                       ▼                            ║
║  ┌──────────────┐        ┌─────────────────┐               ║
║  │Parallel MCTS │        │Hybrid MCTS+Sim  │               ║
║  │              │        │                 │               ║
║  │• UCB1        │        │• Детерминиро-   │               ║
║  │• Selection   │        │  ванная симуляция│               ║
║  │• Expansion   │        │• + Random        │               ║
║  │• Rollouts    │        │  rollouts       │               ║
║  │• Backprop    │        │                 │               ║
║  └──────────────┘        └─────────────────┘               ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝


════════════════════════════════════════════════════════════════
              ПОТОК ДАННЫХ (DATA FLOW)
════════════════════════════════════════════════════════════════

1. НАЧАЛО ХОДА
   ┌──────────────────┐
   │ Игровое          │
   │ состояние        │ Змейка, еда, стены, бонусы
   └────────┬─────────┘
            │
            ▼
   ┌──────────────────┐
   │ Bot Controller   │ Нужно выбрать направление
   └────────┬─────────┘
            │
         Выбор: CPU или GPU?
            │
    ┌───────┴────────┐
    │                │
GPU │                │ CPU
    ▼                ▼

2a. CPU PATH (original)          2b. GPU PATH (new)
   ┌──────────────────┐             ┌──────────────────┐
   │ CPU Simulation   │             │ Конвертация      │
   │ • ~1000 сим/сек  │             │ CPUGameState →   │
   │ • Глубина 3-5    │             │ GPUGameState     │
   │ • ~100ms         │             └────────┬─────────┘
   └────────┬─────────┘                      │
            │                                │ hipMemcpy
            │                                ▼
            │                       ┌──────────────────┐
            │                       │ GPU Memory       │
            │                       │ (device)         │
            │                       └────────┬─────────┘
            │                                │
            │                                ▼
            │                       ┌──────────────────┐
            │                       │ Launch Kernels   │
            │                       │ • 100K+ сим/сек  │
            │                       │ • Глубина 10-15  │
            │                       │ • ~1-10ms        │
            │                       └────────┬─────────┘
            │                                │
            │                                │ hipMemcpy
            │                                ▼
            │                       ┌──────────────────┐
            │                       │ Анализ           │
            │                       │ результатов      │
            │                       └────────┬─────────┘
            │                                │
            └────────┬───────────────────────┘
                     │
3. ВЫБОР НАПРАВЛЕНИЯ │
                     ▼
            ┌──────────────────┐
            │ Best Direction   │ UP/DOWN/LEFT/RIGHT
            │ (Лучший ход)     │
            └────────┬─────────┘
                     │
                     ▼
            ┌──────────────────┐
            │ Выполнить ход    │
            │ в игре           │
            └──────────────────┘


════════════════════════════════════════════════════════════════
          ПАРАЛЛЕЛИЗМ GPU (GPU PARALLELISM)
════════════════════════════════════════════════════════════════

MASSIVE SIMULATION KERNEL:

Grid: [blocks]
  Block 0     Block 1     Block 2    ...    Block N
  ┌──────┐    ┌──────┐    ┌──────┐          ┌──────┐
  │      │    │      │    │      │          │      │
  │ 256  │    │ 256  │    │ 256  │   ...    │ 256  │
  │threads│    │threads│    │threads│       │threads│
  │      │    │      │    │      │          │      │
  └──────┘    └──────┘    └──────┘          └──────┘
     │           │           │                  │
     ▼           ▼           ▼                  ▼
  Симуляция  Симуляция  Симуляция          Симуляция
  0-255      256-511    512-767            N-256..N

Каждый thread:
  • Берёт своё ID (blockIdx * blockDim + threadIdx)
  • Декодирует последовательность ходов из ID
  • Симулирует эту последовательность
  • Записывает результат (score, direction)

Всего: до 4096 threads = 4096 параллельных симуляций!


PARALLEL A* KERNEL:

  Thread 0      Thread 1      Thread 2     ...   Thread N
     │             │             │                   │
     ▼             ▼             ▼                   ▼
  A* path     A* path       A* path             A* path
  (голова→еда) (голова→бонус) (след→еда)         (...)
     │             │             │                   │
     ▼             ▼             ▼                   ▼
  Distance:10  Distance:15   Distance:8          Distance:N

Каждый thread:
  • Независимый A* поиск
  • Свои структуры данных в shared memory
  • Результат: расстояние до цели


PARALLEL BFS KERNEL:

  Thread 0      Thread 1      Thread 2     ...   Thread N
     │             │             │                   │
     ▼             ▼             ▼                   ▼
  BFS для      BFS для       BFS для             BFS для
  состояния 0  состояния 1   состояния 2         состояния N
     │             │             │                   │
     ▼             ▼             ▼                   ▼
  FreeSpace:120 FreeSpace:98  FreeSpace:150      FreeSpace:N

Каждый thread:
  • BFS из головы змейки
  • Подсчёт доступных клеток
  • Результат: количество свободного пространства


════════════════════════════════════════════════════════════════
          MEMORY HIERARCHY (ИЕРАРХИЯ ПАМЯТИ)
════════════════════════════════════════════════════════════════

┌────────────────────────────────────────────────────────────┐
│ CPU (Host) Memory                                          │
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Game State   │  │ Snake[]      │  │ Walls[]      │    │
│  │ (CPU format) │  │              │  │              │    │
│  └──────┬───────┘  └──────────────┘  └──────────────┘    │
│         │                                                  │
│         │ hipMemcpy (H→D)                                 │
└─────────┼──────────────────────────────────────────────────┘
          │
          ▼
┌────────────────────────────────────────────────────────────┐
│ GPU (Device) Global Memory                                 │
│                                                            │
│  ┌──────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │ GPUGameState │  │ Simulation      │  │ Results[]   │  │
│  │              │  │ States[4096]    │  │             │  │
│  └──────────────┘  └─────────────────┘  └─────────────┘  │
│         │                   │                    ▲         │
│         │                   │                    │         │
│         │                   ▼                    │         │
│         │          ┌────────────────┐            │         │
│         │          │ Shared Memory  │────────────┘         │
│         │          │ (per block)    │                      │
│         │          │                │                      │
│         │          │ • A* nodes     │  Быстрый доступ      │
│         │          │ • BFS queue    │  (cache)             │
│         │          │ • MCTS tree    │                      │
│         │          └────────────────┘                      │
│         │                   │                              │
│         └───────────────────┼──────────────────────────────┤
│                             │                              │
│                             ▼                              │
│                    ┌────────────────┐                      │
│                    │ Registers      │                      │
│                    │ (per thread)   │                      │
│                    │                │                      │
│                    │ • Local vars   │  Самый быстрый       │
│                    │ • Temp data    │  доступ              │
│                    └────────────────┘                      │
│                                                            │
└────────────────────────────────────────────────────────────┘


Скорость доступа:
  Registers:       ~1 cycle
  Shared Memory:   ~10-30 cycles
  Global Memory:   ~100-300 cycles
  CPU Memory:      ~1000+ cycles + transfer


════════════════════════════════════════════════════════════════
          ОПТИМИЗАЦИИ (OPTIMIZATIONS)
════════════════════════════════════════════════════════════════

1. COALESCED MEMORY ACCESS

   BAD (AOS - Array of Structures):
   ┌────┬────┬────┬────┐ ┌────┬────┬────┬────┐
   │x0  │y0  │x1  │y1  │ │x2  │y2  │x3  │y3  │
   └─┬──┴──┬─┴──┬─┴──┬─┘ └─┬──┴──┬─┴──┬─┴──┬─┘
     T0   T0  T1  T1     T2   T2  T3  T3
     ↓    ↓   ↓   ↓      ↓    ↓   ↓   ↓
   Разрозненные обращения (медленно)

   GOOD (SOA - Structure of Arrays):
   ┌────┬────┬────┬────┐ ┌────┬────┬────┬────┐
   │x0  │x1  │x2  │x3  │ │y0  │y1  │y2  │y3  │
   └─┬──┴─┬──┴─┬──┴─┬──┘ └─┬──┴─┬──┴─┬──┴─┬──┘
     T0   T1   T2   T3     T0   T1   T2   T3
     ↓    ↓    ↓    ↓      ↓    ↓    ↓    ↓
   Последовательные обращения (быстро!)


2. SHARED MEMORY CACHING

   Global Memory          Shared Memory         Threads
   ┌────────────┐        ┌────────────┐        ┌─────┐
   │            │  Load  │            │  Read  │  T0 │
   │ Game State │───────>│ Cached     │<───────┤  T1 │
   │            │  Once  │ Data       │ Many   │ ... │
   │            │        │            │ Times  │ T255│
   └────────────┘        └────────────┘        └─────┘
   
   Выигрыш: 10-30x быстрее!


3. BITMASKING

   Обычный массив visited[40][30]:
   ┌─┬─┬─┬─┬─┬─┬─┬─┐  1200 bytes
   │0│0│1│0│1│0│0│1│  (по 1 байту на клетку)
   └─┴─┴─┴─┴─┴─┴─┴─┘

   С битовой маской:
   ┌────────┐  150 bytes (8x экономия!)
   │01010011│  (по 1 биту на клетку)
   └────────┘


════════════════════════════════════════════════════════════════
          СРАВНЕНИЕ CPU vs GPU
════════════════════════════════════════════════════════════════

                    CPU Bot          GPU Bot
                    ───────────────────────────────────
Симуляций/сек       ~1,000           ~100,000+
Глубина             3-5              10-15
Время решения       ~100ms           ~1-10ms
Качество решений    Хорошее          Отличное
Использование       1 ядро CPU       512 GPU cores
Память              10 MB RAM        100 MB VRAM
Требования          Любой CPU        AMD GPU + ROCm

                         УСКОРЕНИЕ: 100x! 


════════════════════════════════════════════════════════════════
          ФАЙЛЫ И ИХ РОЛИ
════════════════════════════════════════════════════════════════

Source.c            ──┐
                     │ Игровая логика (CPU)
                     │
                     ├──> botControl()
                     │       │
                     │       ├──> CPU: botControlWithSimulation()
                     │       │         • Рекурсивная симуляция
                     │       │         • A*, BFS
                     │       │         • ~1000 сим/сек
                     │       │
                     │       └──> GPU: botControlGPU()
                     │                   │
hip_bot.h           ─┤                   ▼
hip_bot.cpp         ─┼────> hip_bot_get_decision()
                     │       • Конвертация данных
                     │       • Управление GPU памятью
                     │       • Запуск kernels
                     │       • Анализ результатов
                     │            │
hip_kernels.hip     ─┤            ▼
                     │       GPU Kernels
                     │       • massive_simulation_kernel
                     │       • parallel_astar_kernel
                     │       • parallel_bfs_kernel
                     │       • evaluate_states_kernel
                     │
hip_mcts.hip        ─┤       Advanced Kernels
                     │       • parallel_mcts_kernel
                     │       • hybrid_mcts_simulation_kernel
                     │
hip_types.h         ─┘       Типы данных
                             • GPUGameState
                             • Device функции

hip_test.cpp        ──────>  Тесты и бенчмарки


════════════════════════════════════════════════════════════════

                    🎯 КЛЮЧЕВЫЕ КОНЦЕПЦИИ 🎯

1. МАССИВНАЯ ПАРАЛЛЕЛИЗАЦИЯ
   Один ход CPU → 4096 ходов GPU одновременно

2. MEMORY COALESCING
   Оптимизация доступа к памяти для GPU

3. SHARED MEMORY
   Кэширование данных близко к вычислительным единицам

4. АСИНХРОННОСТЬ
   CPU продолжает работу пока GPU вычисляет

5. ГИБРИДНЫЙ ПОДХОД
   Автоматическое переключение CPU/GPU

════════════════════════════════════════════════════════════════


